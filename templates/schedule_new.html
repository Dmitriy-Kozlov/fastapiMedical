<html>
<head>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 20px;
      background: #f0f2f5;
      color: #333;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      color: #2c3e50;
    }

    .doctors-grid {
      display: grid;
      gap: 20px;
      margin-bottom: 30px;
    }

    .doctor-card {
      background: white;
      border: 1px solid #e1e4e8;
      border-radius: 8px;
      padding: 15px;
      transition: all 0.3s ease;
    }

    .doctor-card:hover {
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      transform: translateY(-2px);
    }

    .doctor-name {
      font-size: 18px;
      font-weight: 500;
      color: #2c3e50;
      margin-bottom: 10px;
    }

    .doctor-specialty {
      color: #666;
      margin-bottom: 10px;
    }

    .schedule-table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
    }

    .schedule-table th, .schedule-table td {
      padding: 8px;
      border: 1px solid #e1e4e8;
      text-align: center;
    }

    .schedule-table th {
      background: #f8f9fa;
    }

    .btn-appointment {
      background: #3498db;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .btn-appointment:hover {
      background: #2980b9;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
    }

    .form-group input, .form-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .success-message {
      display: none;
      color: #27ae60;
      text-align: center;
      margin: 10px 0;
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>Расписание врачей</h1>
  </div>
  <div class="doctors-grid" id="doctorsContainer">
    <!-- Doctors will be loaded here -->
  </div>
</div>
<div class="modal" id="appointmentModal">
  <div class="modal-content">
    <h2>Запись на прием</h2>
    <form id="appointmentForm">
      <div class="form-group">
        <label>Врач:</label>
        <input type="text" id="doctorName" readOnly>
      </div>
      <div class="form-group">
        <label>Дата:</label>
        <input type="date" id="appointmentDate" required>
      </div>
      <div class="form-group">
        <label>Время:</label>
        <select id="appointmentTime" required>
          <!-- Time slots will be populated -->
        </select>
      </div>
      <button type="submit" class="btn-appointment">Записаться</button>
    </form>
    <div class="success-message" id="successMessage">
      Вы успешно записаны на прием!
    </div>
  </div>
</div>
<script>
  const authToken = localStorage.getItem('authToken');
  let doctors = [];

  async function fetchDoctorsData() {
    try {
      const response = await fetch('/api/doctors/all_with_schedule', {
        headers: {'Authorization': `Bearer ${authToken}`}
      });
      if (!response.ok) throw new Error('Failed to fetch doctors');
      return await response.json();
    } catch (error) {
      console.error('Error fetching doctors:', error);
    }
  }

  function createDoctorCard(doctor) {
    const card = document.createElement('div');
    card.className = 'doctor-card';
    const scheduleHtml = Object.entries(doctor.schedule)
            .map(([day, hours]) => `<tr><td>${day}</td><td>${hours}</td></tr>`)
            .join('');
    card.innerHTML = `
        <div class="doctor-name">${doctor.last_name} ${doctor.first_name}</div>
        <div class="doctor-specialty">${doctor.specialization}</div>
        <table class="schedule-table">
            <thead><tr><th>День</th><th>Часы приема</th></tr></thead>
            <tbody>${scheduleHtml}</tbody>
        </table>
        <button class="btn-appointment" data-doctor-id="${doctor.id}" onclick="openAppointmentModal(${doctor.id}, '${doctor.last_name} ${doctor.first_name}')">Записаться на прием</button>
    `;
    return card;
  }

  function loadDoctors(doctors) {
    const container = document.getElementById('doctorsContainer');
    doctors.forEach(doctor => container.appendChild(createDoctorCard(doctor)));
  }

//
//   async function loadAvailableSlots(doctorId, selectedDate) {
//     const timeSelect = document.getElementById('appointmentTime');
//     if (!timeSelect) {
//     console.error('Элемент appointmentTime не найден в DOM');
//     return;
// }
//     console.log(timeSelect.innerHTML)
//     timeSelect.innerHTML = ''; // Очистка списка времени
//     console.log("Очистка списка времени")
//     console.log(timeSelect.innerHTML)
//
//     // Проверяем валидность входных данных
//     if (!doctorId || !selectedDate) {
//         console.error('Не указан врач или дата для загрузки слотов.');
//         return;
//     }
//
//     // Получаем расписание врача
//     const doctor = doctors.find(d => d.id === doctorId);
//     if (!doctor || !doctor.schedule) {
//         console.error('Расписание врача не найдено.');
//         return;
//     }
//
//     const dayNames = ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'];
//     const dayName = dayNames[new Date(selectedDate).getDay()];
//     const workHours = doctor.schedule[dayName];
//
//     if (!workHours) {
//         console.warn('Врач не работает в выбранный день.');
//         return;
//     }
//
//     // Получаем время начала и окончания работы
//     const [startTime, endTime] = workHours.split(' - ');
//     const startHour = parseInt(startTime.split(':')[0]);
//     const endHour = parseInt(endTime.split(':')[0]);
//
//     // Запрашиваем занятые слоты на указанную дату
//     try {
//         const response = await fetch('/api/appointments/filter', {
//             method: 'POST',
//             headers: {
//                 'Content-Type': 'application/json',
//                 'Authorization': `Bearer ${authToken}`
//             },
//             body: JSON.stringify({ doctor_id: doctorId, input_date: selectedDate })
//         });
//
//         if (!response.ok) {
//             console.error('Ошибка при загрузке занятых слотов.');
//             return;
//         }
//
//         const occupiedSlots = await response.json();
//         const occupiedTimes = occupiedSlots.map(a => new Date(a.appointment_date).toTimeString().slice(0, 5));
//
//         // Генерируем доступные временные слоты
//         for (let hour = startHour; hour < endHour; hour++) {
//             ['00', '30'].forEach(minutes => {
//                 const slot = `${hour.toString().padStart(2, '0')}:${minutes}`;
//                 if (!occupiedTimes.includes(slot)) {
//                     const option = document.createElement('option');
//                     option.value = slot;
//                     option.textContent = slot;
//                     timeSelect.appendChild(option);
//                 }
//             });
//         }
//
//         // Если слоты отсутствуют
//         if (!timeSelect.hasChildNodes()) {
//             const option = document.createElement('option');
//             option.value = '';
//             option.textContent = 'Нет доступного времени';
//             timeSelect.appendChild(option);
//         }
//     } catch (error) {
//         console.error('Ошибка при загрузке доступных временных слотов:', error);
//     }
// }





  async function loadAvailableSlots(doctorId, selectedDate) {
    const timeSelect = document.getElementById('appointmentTime');
    if (!timeSelect) {
        console.error('Элемент appointmentTime не найден в DOM');
        return;
    }

    // Очистка списка времени
    timeSelect.innerHTML = '';
    console.log('Очистка слотов, текущие слоты:', timeSelect.innerHTML);

    if (!doctorId || !selectedDate) {
        console.error('Не указан врач или дата для загрузки слотов.');
        return;
    }

    const doctor = doctors.find(d => d.id === doctorId);
    if (!doctor || !doctor.schedule) {
        console.error('Расписание врача не найдено.');
        return;
    }

    const dayNames = ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'];
    const dayName = dayNames[new Date(selectedDate).getDay()];
    const workHours = doctor.schedule[dayName];

    if (!workHours) {
        console.warn('Врач не работает в выбранный день.');
        return;
    }

    const [startTime, endTime] = workHours.split(' - ');
    const startHour = parseInt(startTime.split(':')[0]);
    const endHour = parseInt(endTime.split(':')[0]);

    try {
        const response = await fetch('/api/appointments/filter', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({ doctor_id: doctorId, input_date: selectedDate })
        });

        if (!response.ok) {
            console.error('Ошибка при загрузке занятых слотов.');
            return;
        }

        const occupiedSlots = await response.json();
        const occupiedTimes = occupiedSlots.map(a => new Date(a.appointment_date).toTimeString().slice(0, 5));

        for (let hour = startHour; hour < endHour; hour++) {
            ['00', '30'].forEach(minutes => {
                const slot = `${hour.toString().padStart(2, '0')}:${minutes}`;
                if (!occupiedTimes.includes(slot) && !Array.from(timeSelect.options).some(option => option.value === slot)) {
                    const option = document.createElement('option');
                    option.value = slot;
                    option.textContent = slot;
                    timeSelect.appendChild(option);
                }
            });
        }

        if (!timeSelect.hasChildNodes()) {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'Нет доступного времени';
            timeSelect.appendChild(option);
        }
    } catch (error) {
        console.error('Ошибка при загрузке доступных временных слотов:', error);
    }
}



  async function openAppointmentModal(doctorId, doctorName) {
    const modal = document.getElementById('appointmentModal');
    const doctorNameInput = document.getElementById('doctorName');
    doctorNameInput.value = doctorName;
    document.getElementById('appointmentDate').addEventListener('change', (e) => {
      loadAvailableSlots(doctorId, e.target.value);
    });
    const successMessage = document.getElementById('successMessage');
    successMessage.style.display = 'none';
    modal.style.display = 'flex';
  }

  // Close modal when clicking outside
document.getElementById('appointmentModal').addEventListener('click', (e) => {
  if (e.target === document.getElementById('appointmentModal')) {
    e.target.style.display = 'none';
  }
});

//
// document.getElementById('appointmentDate').addEventListener('change', (e) => {
//     const selectedDate = e.target.value;
//     // const doctorId = doctors.find(d => d.name === document.getElementById('doctorName').value)?.id;
//     const doctorId = event.target.dataset.doctorId;
//     console.log(doctorId)
//     if (doctorId && selectedDate) {
//         loadAvailableSlots(doctorId, selectedDate);
//     }
// });


document.getElementById('appointmentForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    console.log(document.getElementById('appointmentTime').value)
    let patient_id = localStorage.getItem('patientId') // Предполагается, что `patientId` сохранен в localStorage
    console.log(patient_id)
  const doctorName = document.getElementById('doctorName').value;
    const doctor = doctors.find(d => `${d.last_name} ${d.first_name}` === doctorName);
    if (!doctor) {
        alert('Ошибка: врач не найден');
        return;
    }
    // if (patient_id == null) {
if (!patient_id || patient_id === "null") {
  alert(`Ошибка: Id пациента не найдено`);
} else {
      const formData = {
        patient_id: patient_id,
        // doctor_id: doctors.find(d => d.name === document.getElementById('doctorName').value)?.id,
        doctor_id: doctor.id,
        appointment_date: new Date(
            `${document.getElementById('appointmentDate').value}T${document.getElementById('appointmentTime').value}`
        ).toISOString(),
        notes: '' // Если есть поле для заметок, можно заменить на его значение
    };


    try {
        const response = await fetch('/api/appointments/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(formData)
        });
        console.log(formData)
        if (response.status === 401 || response.status === 403) {
        window.location.href = '/pages/login';
        }

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to create appointment');
        }

        // Показываем сообщение об успехе
        document.getElementById('successMessage').style.display = 'block';

        // Сбрасываем форму
        document.getElementById('appointmentDate').value = '';
        document.getElementById('appointmentTime').value = '';

        // Закрываем модальное окно через 2 секунды
        setTimeout(() => {
            document.getElementById('appointmentModal').style.display = 'none';
        }, 2000);
    } catch (error) {
        console.error('Error creating appointment:', error);
        alert(`Ошибка: ${error.detail}`);
    }
}

});


  // Additional functions here...

  document.addEventListener('DOMContentLoaded', async () => {
    doctors = await fetchDoctorsData();
    if (doctors) loadDoctors(doctors);
  });
</script>
</body>
</html>
