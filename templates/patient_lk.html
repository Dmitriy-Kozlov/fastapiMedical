<html><head><base href="." />
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Медицинский центр - Личный кабинет</title>
<style>
:root {
    --primary: #2b87d1;
    --primary-dark: #1a68a5;
    --accent: #4CAF50;
    --gray: #f5f7fa;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body {
    min-height: 100vh;
    background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);
}

.header {
    background: white;
    padding: 1rem 2rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.logo {
    width: 50px;
    height: 50px;
}

.profile-container {
    max-width: 1200px;
    margin: 2rem auto;
    padding: 0 1rem;
}

.profile-grid {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 2rem;
}

.info-card {
    background: white;
    padding: 2rem;
    border-radius: 10px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.1);
}

.profile-photo {
    width: 150px;
    height: 150px;
    background: var(--gray);
    border-radius: 50%;
    margin: 0 auto 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
}

.info-list {
    list-style: none;
}

.info-item {
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #eee;
}

.info-label {
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 0.3rem;
}

.info-value {
    color: #333;
    font-weight: 500;
}

.appointments-section {
    background: white;
    padding: 2rem;
    border-radius: 10px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.1);
}

.appointments-tabs {
    display: flex;
    margin-bottom: 1.5rem;
    border-bottom: 2px solid #eee;
}

.tab {
    padding: 0.8rem 1.5rem;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
}

.tab.active {
    border-bottom-color: var(--primary);
    color: var(--primary);
    font-weight: 500;
}

.appointment-card {
    padding: 1rem;
    border: 1px solid #eee;
    border-radius: 5px;
    margin-bottom: 1rem;
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 1rem;
    align-items: center;
}

.appointment-date {
    text-align: center;
    padding-right: 1rem;
    border-right: 1px solid #eee;
}

.appointment-day {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--primary);
}

.appointment-month {
    color: #666;
}

.appointment-info h3 {
    margin-bottom: 0.3rem;
}

.appointment-time {
    color: #666;
}

.status-badge {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
}

.status-scheduled {
    background: #e1f5fe;
    color: var(--primary);
}

.status-completed {
    background: #e8f5e9;
    color: var(--accent);
}

.logout-btn {
    padding: 0.5rem 1rem;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s;
}

.logout-btn:hover {
    background: var(--primary-dark);
}

.loading {
    text-align: center;
    padding: 2rem;
    color: #666;
}

.loading-spinner {
    display: inline-block;
    width: 50px;
    height: 50px;
    border: 3px solid rgba(43, 135, 209, 0.2);
    border-radius: 50%;
    border-top-color: var(--primary);
    animation: spin 1s ease-in-out infinite;
    margin-bottom: 1rem;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.error-message {
    color: #d32f2f;
    padding: 1rem;
    background: #ffebee;
    border-radius: 5px;
    margin: 1rem 0;
}



.edit-btn {
    padding: 0.5rem 1rem;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s;
    margin-top: 1rem;
    width: 100%;
}

.edit-btn:hover {
    background: #3d8b40;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
}

.modal-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 2rem;
    border-radius: 10px;
    width: 90%;
    max-width: 500px;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.close-btn {
    border: none;
    background: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #666;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    color: #666;
}

.form-group input {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 5px;
}

.save-btn {
    padding: 0.5rem 1rem;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    width: 100%;
    margin-top: 1rem;
}

.save-btn:hover {
    background: #3d8b40;
}



</style>
</head>
<body>
    <header class="header">
        <svg class="logo" viewBox="0 0 100 100">
            <circle cx="50" cy="50" r="45" fill="none" stroke="#2b87d1" stroke-width="5"/>
            <path d="M30 50 h40 M50 30 v40" stroke="#2b87d1" stroke-width="5" stroke-linecap="round"/>
        </svg>
        <button class="logout-btn" onclick="handleLogout()">Выйти</button>
    </header>

    <div class="profile-container">
        <div class="profile-grid">
            <div class="info-card" id="patientInfo">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div>Загрузка данных...</div>
                </div>
            </div>


            <div class="appointments-section">
                <div class="appointments-tabs">
                    <div class="tab active" onclick="switchTab('upcoming', patientData, event)">Предстоящие приёмы</div>
                    <div class="tab" onclick="switchTab('past', patientData, event)">История приёмов</div>
                </div>
                <div id="appointmentsContainer">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <div>Загрузка приёмов...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Редактировать данные</h2>
                <button class="close-btn" onclick="closeEditModal()">&times;</button>
            </div>
            <form id="editForm" onsubmit="handleSubmit(event)">
                <div class="form-group">
                    <label for="last_name">Фамилия</label>
                    <input type="text" id="last_name" name="last_name" required>
                </div>
                <div class="form-group">
                    <label for="first_name">Имя</label>
                    <input type="text" id="first_name" name="first_name" required>
                </div>
                <div class="form-group">
                    <label for="birth_date">Дата рождения</label>
                    <input type="date" id="birth_date" name="birth_date" required>
                </div>
                <div class="form-group">
                    <label for="phone_number">Телефон</label>
                    <input type="tel" id="phone_number" name="phone_number" required>
                </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" required>
                </div>
                <button type="submit" class="save-btn">Сохранить</button>
            </form>
        </div>
    </div>


<script>
const authToken = localStorage.getItem('authToken')


function openEditModal() {
    const modal = document.getElementById('editModal');
    // Populate form with current data
    document.getElementById('last_name').value = patientData.last_name;
    document.getElementById('first_name').value = patientData.first_name;
    document.getElementById('birth_date').value = patientData.birth_date;
    document.getElementById('phone_number').value = patientData.phone_number;
    document.getElementById('email').value = patientData.email;
    modal.style.display = 'block';
}

function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
}


async function handleSubmit(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    let updatedData = Object.fromEntries(formData.entries());
    updatedData.id = patientData.id
    console.log(updatedData)

    try {
        const response = await fetch('/api/patients/patient/edit', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(updatedData)
        });
        if (response.status === 401 || response.status === 403) {
            window.location.href = '/pages/login';
        }
        if (response.ok) {
            patientData = await response.json();
            patientData = await fetchPatientData();
            renderPatientInfo(patientData);
            closeEditModal();
        } else {
            throw new Error('Failed to update patient data');
        }
    } catch (error) {
        console.error('Error updating patient data:', error);
        alert('Произошла ошибка при обновлении данных');
    }
}


async function fetchPatientData() {
    try {
        const response = await fetch('/api/patients/patient', {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        if (response.status === 401 || response.status === 403) {
        window.location.href = '/pages/login';
        }
        if (!response.ok) {
            throw new Error('Failed to fetch patient data');
        }
        const data = await response.json();
        return data;
    } catch (error) {
        console.error('Error fetching patient data:', error);
        throw error;
    }
}

function renderPatientInfo(patient) {
    const formattedDate = formatDate(patient.birth_date)
    const patientInfoHtml = `
        <div class="profile-photo">
            <svg width="80" height="80" viewBox="0 0 24 24" fill="#999">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
        </div>
        <ul class="info-list">
            <li class="info-item">
                <div class="info-label">Фамилия</div>
                <div class="info-value">${patient.last_name}</div>
            </li>
            <li class="info-item">
                <div class="info-label">Имя</div>
                <div class="info-value">${patient.first_name}</div>
            </li>
            <li class="info-item">
                <div class="info-label">Дата рождения</div>
                <div class="info-value">${formattedDate}</div>
            </li>
            <li class="info-item">
                <div class="info-label">Телефон</div>
                <div class="info-value">${patient.phone_number}</div>
            </li>
            <li class="info-item">
                <div class="info-label">Email</div>
                <div class="info-value">${patient.email}</div>
            </li>
        </ul>
        <button class="edit-btn" onclick="openEditModal()">Редактировать данные</button>

    `;
    document.getElementById('patientInfo').innerHTML = patientInfoHtml;
}
                        // ${new Date(appointment.appointment_date).getHours()}:${new Date(appointment.appointment_date).getMinutes().toString().padStart(2, '0')}

function createAppointmentCard(appointment) {
    const appointmentDate = new Date(appointment.appointment_date);

// Преобразование времени с учетом временной зоны
const localDateString = appointmentDate.toLocaleString('ru-RU', {
    // timeZone: 'Europe/Moscow',
    // timeZone: 'UTC',
    hour: '2-digit',
    minute: '2-digit',
    hour12: false, // Для 24-часового формата
});

// Разделение часов и минут
const [hours, minutes] = localDateString.split(':');
    return `
        <div class="appointment-card">
            <div class="appointment-date">
                <div class="appointment-day">${new Date(appointment.appointment_date).getDate()}</div>
                <div class="appointment-month">${new Date(appointment.appointment_date).toLocaleString('ru', { month: 'short' })}</div>
            </div>
            <div class="appointment-info">
                <h3>${appointment.doctor.first_name} ${appointment.doctor.last_name}</h3>
                <div>${appointment.doctor.specialization}</div>
                    <div class="appointment-time">
                        ${hours}:${minutes}
                    </div>
                </div>
            <div class="status-badge status-${appointment.status}">
                ${appointment.status === 'scheduled' ? 'Предстоящий' : 'Завершён'}
            </div>
        </div>
    `;
}

async function switchTab(typeApp, patient, event) {
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => tab.classList.remove('active'));
    if (event && event.target) {
        event.target.classList.add('active');
    }

    const container = document.getElementById('appointmentsContainer');
    container.innerHTML = '<div class="loading"><div class="loading-spinner"></div><div>Загрузка приёмов...</div></div>';

    try {
        const response = await fetch(`/api/patients/patient/appointments?status=${typeApp === 'upcoming' ? 'scheduled' : 'completed'}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
        },
        body: JSON.stringify({"patient_id": patient.id})
    })
        if (response.status === 401 || response.status === 403) {
        window.location.href = '/pages/login';
        }
        if (!response.ok) throw new Error('Failed to fetch appointments');
        const appointments = await response.json();
        appointments.sort((a, b) => new Date(a.appointment_date) - new Date(b.appointment_date));
        container.innerHTML = appointments
            .map(appointment => createAppointmentCard(appointment))
            .join('') || '<div class="info-value">Нет приёмов</div>';
    } catch (error) {
        container.innerHTML = '<div class="error-message">Ошибка при загрузке данных. Пожалуйста, попробуйте позже.</div>';
        console.error('Error fetching appointments:', error);
    }
}

function handleLogout() {
    if (confirm('Вы уверены, что хотите выйти?')) {
        localStorage.removeItem('authToken')
        window.location.href = '/pages/login';
    }
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return new Intl.DateTimeFormat('ru-RU', {
        day: 'numeric',
        month: 'long',
        year: 'numeric'
    }).format(date);
}

let patientData = null;
// Initialize page
document.addEventListener('DOMContentLoaded', async () => {
    try {
        patientData = await fetchPatientData();
        renderPatientInfo(patientData);
        await switchTab('upcoming', patientData);
    } catch (error) {
        document.getElementById('patientInfo').innerHTML = '<div class="error-message">Ошибка при загрузке данных. Пожалуйста, попробуйте позже.</div>';
        console.log(error)
    }
});
</script>
</body></html>