<html><head><base href="<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
<style>
body {
  font-family: 'Roboto', sans-serif;
  margin: 0;
  padding: 20px;
  background: #f0f2f5;
  color: #333;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.header {
  text-align: center;
  margin-bottom: 30px;
  color: #2c3e50;
}

.doctors-grid {
  display: grid;
  gap: 20px;
  margin-bottom: 30px;
}

.doctor-card {
  background: white;
  border: 1px solid #e1e4e8;
  border-radius: 8px;
  padding: 15px;
  transition: all 0.3s ease;
}

.doctor-card:hover {
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  transform: translateY(-2px);
}

.doctor-name {
  font-size: 18px;
  font-weight: 500;
  color: #2c3e50;
  margin-bottom: 10px;
}

.doctor-specialty {
  color: #666;
  margin-bottom: 10px;
}

.schedule-table {
  width: 100%;
  border-collapse: collapse;
  margin: 10px 0;
}

.schedule-table th, .schedule-table td {
  padding: 8px;
  border: 1px solid #e1e4e8;
  text-align: center;
}

.schedule-table th {
  background: #f8f9fa;
}

.btn-appointment {
  background: #3498db;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  transition: background 0.3s ease;
}

.btn-appointment:hover {
  background: #2980b9;
}

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  justify-content: center;
  align-items: center;
}

.modal-content {
  background: white;
  padding: 20px;
  border-radius: 8px;
  width: 90%;
  max-width: 500px;
}

.form-group {
  margin-bottom: 15px;
}

.form-group label {
  display: block;
  margin-bottom: 5px;
}

.form-group input, .form-group select {
  width: 100%;
  padding: 8px;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.success-message {
  display: none;
  color: #27ae60;
  text-align: center;
  margin: 10px 0;
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>Расписание врачей</h1>
  </div>

  <div class="doctors-grid" id="doctorsContainer">
    <!-- Doctors will be loaded here -->
  </div>
</div>

<div class="modal" id="appointmentModal">
  <div class="modal-content">
    <h2>Запись на прием</h2>
    <form id="appointmentForm">
      <div class="form-group">
        <label>Врач:</label>
        <input type="text" id="doctorName" readonly>
      </div>
      <div class="form-group">
        <label>Дата:</label>
        <input type="date" id="appointmentDate" required>
      </div>
      <div class="form-group">
        <label>Время:</label>
        <select id="appointmentTime" required>
          <!-- Time slots will be populated based on doctor's schedule -->
        </select>
      </div>
      <button type="submit" class="btn-appointment">Записаться</button>
    </form>
    <div class="success-message" id="successMessage">
      Вы успешно записаны на прием!
    </div>
  </div>
</div>

<script>

const authToken = localStorage.getItem('authToken')

function createDoctorCard(doctor) {
  const card = document.createElement('div');
  card.className = 'doctor-card';

  const scheduleHtml = Object.entries(doctor.schedule)
    .map(([day, hours]) => `
      <tr>
        <td>${day}</td>
        <td>${hours}</td>
      </tr>
    `).join('');

  card.innerHTML = `
    <div class="doctor-name">${doctor.name}</div>
    <div class="doctor-specialty">${doctor.specialty}</div>
    <table class="schedule-table">
      <thead>
        <tr>
          <th>День</th>
          <th>Часы приема</th>
        </tr>
      </thead>
      <tbody>
        ${scheduleHtml}
      </tbody>
    </table>
    <button class="btn-appointment" onclick="openAppointmentModal('${doctor.name}')">
      Записаться на прием
    </button>
  `;

  return card;
}

function loadDoctors() {
  const container = document.getElementById('doctorsContainer');
  doctors.forEach(doctor => {
    container.appendChild(createDoctorCard(doctor));
  });
}

function openAppointmentModal(doctorName) {
  const modal = document.getElementById('appointmentModal');
  const doctorNameInput = document.getElementById('doctorName');
  const successMessage = document.getElementById('successMessage');

  doctorNameInput.value = doctorName;
  successMessage.style.display = 'none';
  modal.style.display = 'flex';
}

// Close modal when clicking outside
document.getElementById('appointmentModal').addEventListener('click', (e) => {
  if (e.target === document.getElementById('appointmentModal')) {
    e.target.style.display = 'none';
  }
});


document.getElementById('appointmentForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    console.log(document.getElementById('appointmentTime').value)
    const formData = {
        patient_id: localStorage.getItem('patientId'), // Предполагается, что `patientId` сохранен в localStorage
        doctor_id: doctors.find(d => d.name === document.getElementById('doctorName').value)?.id,
        appointment_date: new Date(
            `${document.getElementById('appointmentDate').value}T${document.getElementById('appointmentTime').value}`
        ).toISOString(),
        notes: '' // Если есть поле для заметок, можно заменить на его значение
    };

    try {
        const response = await fetch('/api/appointments/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(formData)
        });
        console.log(formData)
        if (response.status === 401) {
            window.location.href = '/pages/login';
        }

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to create appointment');
        }

        // Показываем сообщение об успехе
        document.getElementById('successMessage').style.display = 'block';

        // Сбрасываем форму
        document.getElementById('appointmentDate').value = '';
        document.getElementById('appointmentTime').value = '';

        // Закрываем модальное окно через 2 секунды
        setTimeout(() => {
            document.getElementById('appointmentModal').style.display = 'none';
        }, 2000);
    } catch (error) {
        console.error('Error creating appointment:', error);
        alert(`Ошибка: ${error.message}`);
    }
});


async function loadAvailableSlots(doctorId, selectedDate) {
    const timeSelect = document.getElementById('appointmentTime');
    timeSelect.innerHTML = '';

    // Get doctor's working hours
    const doctor = doctors.find(d => d.id === doctorId);
    if (!doctor || !doctor.schedule) return;

    const dayNames = ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'];
    const dayName = dayNames[new Date(selectedDate).getDay()];
    if (!doctor.schedule[dayName]) return;

    const [start, end] = doctor.schedule[dayName].split(' - ');
    const startHour = parseInt(start.split(':')[0]);
    const endHour = parseInt(end.split(':')[0]);

    // Fetch occupied slots from backend
    const response = await fetch('/api/appointments/filter', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
        },
        body: JSON.stringify({
            doctor_id: doctorId,
            input_date: selectedDate
        })
    });

    if (!response.ok) {
        console.error('Failed to load appointments');
        return;
    }

    const occupiedSlots = await response.json();
    const occupiedTimes = occupiedSlots.map(a => new Date(a.appointment_date).toTimeString().slice(0, 5));

    // Generate available time slots
    for (let hour = startHour; hour < endHour; hour++) {
        ['00', '30'].forEach(minutes => {
            const slot = `${hour.toString().padStart(2, '0')}:${minutes}`;
            if (!occupiedTimes.includes(slot)) {
                const option = document.createElement('option');
                option.value = slot;
                option.textContent = slot;
                timeSelect.appendChild(option);
            }
        });
    }
}

// Attach the function to the date input change event
document.getElementById('appointmentDate').addEventListener('change', (e) => {
    const selectedDate = e.target.value;
    const doctorId = doctors.find(d => d.name === document.getElementById('doctorName').value)?.id;
    if (doctorId && selectedDate) {
        loadAvailableSlots(doctorId, selectedDate);
    }
});



async function fetchDoctorsData() {
    try {
        const response = await fetch('/api/doctors/all_with_schedule', {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        if (response.status === 401) {
        window.location.href = '/pages/login';
        }
        if (!response.ok) {
            throw new Error('Failed to fetch patient data');
        }
        const data = await response.json();
        return data;
    } catch (error) {
        console.error('Error fetching patient data:', error);
        throw error;
    }
}


// Load doctors when page loads
// document.addEventListener('DOMContentLoaded', loadDoctors);


let doctors = null;
// Initialize page
document.addEventListener('DOMContentLoaded', async () => {
    try {
        doctors = await fetchDoctorsData();
        loadDoctors(doctors);
    } catch (error) {
        console.log(error)
    }
});

</script>
</body></html>